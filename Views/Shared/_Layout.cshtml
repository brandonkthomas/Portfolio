@inject IConfiguration Configuration

@{
    // Page-type flag used across the layout (kept in outer scope so it works inside TagHelpers like <environment/>)
    var canPinchToZoom = (ViewData["CanPinchToZoom"] as bool?) ?? false;
    var isIsolatedCss = (ViewData["IsolatedCss"] as bool?) ?? false;
    var enableStarfield = (ViewData["EnableStarfield"] as bool?) ?? !canPinchToZoom;

    // Prefer an explicit public base URL for canonical + OpenGraph (prevents leaking internal/origin hosts).
    var configuredPublicBaseUrl = Configuration["Site:PublicBaseUrl"];

    string ResolveBaseUrl()
    {
        if (!string.IsNullOrWhiteSpace(configuredPublicBaseUrl) &&
            Uri.TryCreate(configuredPublicBaseUrl, UriKind.Absolute, out var configuredUri))
        {
            return configuredUri.GetLeftPart(UriPartial.Authority);
        }

        // Fallback: honor proxy headers if present (ForwardedHeaders middleware may also update Request.Host/Scheme).
        var forwardedProto = (string?)Context.Request.Headers["X-Forwarded-Proto"];
        var forwardedHost = (string?)Context.Request.Headers["X-Forwarded-Host"];

        var scheme = !string.IsNullOrWhiteSpace(forwardedProto)
            ? forwardedProto.Split(',')[0].Trim()
            : Context.Request.Scheme;

        var host = !string.IsNullOrWhiteSpace(forwardedHost)
            ? forwardedHost.Split(',')[0].Trim()
            : Context.Request.Host.Value;

        return $"{scheme}://{host}";
    }

    var baseUrl = ResolveBaseUrl().TrimEnd('/');
    var absolutePageUrl = $"{baseUrl}{Context.Request.PathBase}{Context.Request.Path}{Context.Request.QueryString}";
    var absoluteOgImage = $"{baseUrl}/assets/meta/card-front-opengraph.png";

    // Title host can be hardcoded to the public site host (so localhost doesn't show 127.0.0.1 in titles).
    var configuredTitleHost = Configuration["Site:TitleHost"];
    var siteHost = !string.IsNullOrWhiteSpace(configuredTitleHost)
        ? configuredTitleHost.Trim()
        : new Uri(baseUrl, UriKind.Absolute).Host;
    var pageTitle = (ViewData["Title"] as string)?.Trim();
    var fullTitle = string.IsNullOrWhiteSpace(pageTitle) ? siteHost : $"{pageTitle} \u2013 {siteHost}";

    // SPA shell pages want a stable browser-tab title, but still need per-route SEO/share titles.
    var forceSiteTitle = (ViewData["ForceSiteTitle"] as bool?) ?? false;
    var tabTitle = forceSiteTitle ? siteHost : fullTitle;
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#1c1c1c">

    <meta name="apple-mobile-web-app-title" content="Brandon Thomas">
    <meta name="description" content="Brandon Thomas - portfolio, projects, contact info" />
    
    <title>@tabTitle</title>

    @if (!isIsolatedCss)
    {
        <link rel="stylesheet" href="~/css/common.css" asp-append-version="true" />
        <link rel="stylesheet" href="~/apps/indium/dist/components/navbar.css" asp-append-version="true" />
        <link rel="stylesheet" href="~/css/starfield.css" asp-append-version="true" />
        <link rel="stylesheet" href="~/css/components/glassSurface.css" asp-append-version="true" />
        <link rel="stylesheet" href="~/css/photoGallery.css" asp-append-version="true" />
        <link rel="stylesheet" href="~/css/projects.css" asp-append-version="true" />
        <link rel="stylesheet" href="~/css/components/dialogs.css" asp-append-version="true" />
    }

    @await RenderSectionAsync("Styles", required: false)

    <link rel="preconnect" href="https://cdnjs.cloudflare.com" />

    <link rel="icon" href="~/assets/images/branding/favicon.ico" asp-append-version="true" />
    <link rel="apple-touch-icon" sizes="180x180" href="~/assets/images/branding/apple-touch-icon-180x180.png" asp-append-version="true" />
    <link rel="apple-touch-icon" sizes="167x167" href="~/assets/images/branding/apple-touch-icon-167x167.png" asp-append-version="true" />
    <link rel="apple-touch-icon" sizes="152x152" href="~/assets/images/branding/apple-touch-icon-152x152.png" asp-append-version="true" />
    <link rel="apple-touch-icon" sizes="144x144" href="~/assets/images/branding/apple-touch-icon-144x144.png" asp-append-version="true" />
    <link rel="apple-touch-icon" sizes="120x120" href="~/assets/images/branding/apple-touch-icon-120x120.png" asp-append-version="true" />
    <link rel="mask-icon" href="~/assets/meta/safari-pinned-tab.svg" color="#1c1c1c" asp-append-version="true">
    
    <link rel="canonical" href="@absolutePageUrl" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="@fullTitle" />
    <meta property="og:description" content="Brandon Thomas - portfolio, projects, contact info" />
    <meta property="og:image" content="@absoluteOgImage" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:image:alt" content="Brandon Thomas - portfolio" />
    <meta property="og:url" content="@absolutePageUrl" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="@fullTitle" />
    <meta name="twitter:image" content="@absoluteOgImage" />

    @if (!canPinchToZoom)
    {
        <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js" defer></script>
    }
</head>
<body class="@(canPinchToZoom ? "can-pinch-to-zoom" : "")" data-initial-state="loading" data-enable-starfield="@(enableStarfield.ToString().ToLowerInvariant())">
    @{
        var showLoadingOverlay = (ViewData["ShowLoadingOverlay"] as bool?) ?? true;
        var loadingLogoSrc = ViewData["LoadingOverlayLogoSrc"] as string ?? "/assets/svg/bt-logo-boxed.svg";
        var loadingLogoAlt = ViewData["LoadingOverlayLogoAlt"] as string ?? "Brandon Thomas Logo";
        var loadingThrobberSrc = ViewData["LoadingOverlayThrobberSrc"] as string ?? "/assets/svg/throbber-ring-indef.svg";
        var loadingThrobberAlt = ViewData["LoadingOverlayThrobberAlt"] as string ?? "";

        // By default, isolated pages hide the navbar unless explicitly overridden.
        var hideNavbar = (ViewData["HideNavbar"] as bool?) ?? isIsolatedCss;
    }
    @if (showLoadingOverlay)
    {
        <div class="loading-overlay" aria-hidden="true">
            <img src="@loadingLogoSrc" alt="@loadingLogoAlt" class="loading-logo" fetchpriority="high" />
            <img src="@loadingThrobberSrc" alt="@loadingThrobberAlt" class="loading-throbber" />
        </div>
    }
    @if (!hideNavbar)
    {
    <div class="url-display">
        <div class="glass-surface-wrapper">
            <div class="url-display-content">
                <div class="url-display-main">
                    <span class="url-text">brandonthomas.net</span>
                    <nav class="url-nav-links desktop">
                        <a href="/photos" class="url-link url-link-photos" data-nav-link="photos" aria-label="Photos">
                            <img src="~/assets/svg/photo-filled.svg" alt="" width="20" height="20" />
                            <span>Photos</span>
                        </a>
                        <a href="/projects" class="url-link url-link-projects" data-nav-link="projects" aria-label="Projects">
                            <img src="~/assets/svg/project-filled.svg" alt="" width="20" height="20" />
                            <span>Projects</span>
                        </a>
                        <a href="https://linkedin.com/in/brandonkthomas" class="url-link url-link-external" rel="noopener noreferrer" aria-label="LinkedIn">
                            <img src="~/assets/svg/linkedin-logo-filled.svg" alt="" width="20" height="20" />
                            <span>
                                LinkedIn
                                <sup class="url-link-external-sup" aria-hidden="true">
                                    <img src="~/assets/svg/external-link-nobox.svg" alt="" width="14" height="14" class="url-link-external-sup-icon" />
                                </sup>
                            </span>
                        </a>
                        <a href="mailto:me@brandonthomas.net" class="url-link url-link-external" aria-label="Contact">
                            <img src="~/assets/svg/email-filled.svg" alt="" width="20" height="20" />
                            <span>
                                Contact
                                <sup class="url-link-external-sup" aria-hidden="true">
                                    <img src="~/assets/svg/external-link-nobox.svg" alt="" width="14" height="14" class="url-link-external-sup-icon" />
                                </sup>
                            </span>
                        </a>
                    </nav>
                    <button class="burger-menu mobile" aria-label="Menu" aria-expanded="false">
                        <span class="burger-icon">
                            <span class="burger-line burger-line-1"></span>
                            <span class="burger-line burger-line-2"></span>
                        </span>
                    </button>
                </div>
                <nav class="url-nav-links mobile">
                    @{
                        var isPhotosPage = Context.Request.Path.StartsWithSegments("/photos", StringComparison.OrdinalIgnoreCase);
                        var isProjectsPage = Context.Request.Path.StartsWithSegments("/projects", StringComparison.OrdinalIgnoreCase);
                    }
                    <a href="/photos" class="url-link url-link-photos" data-nav-link="photos">
                        @if (isPhotosPage)
                        {
                            <img src="~/assets/svg/bt-logo-boxed.svg" alt="" width="20" height="20" />
                            <span>Card</span>
                        }
                        else
                        {
                            <img src="~/assets/svg/polaroid-filled.svg" alt="" width="20" height="20" />
                            <span>Photos</span>
                        }
                    </a>
                    <a href="/projects" class="url-link url-link-projects" data-nav-link="projects">
                        @if (isProjectsPage)
                        {
                            <img src="~/assets/svg/bt-logo-boxed.svg" alt="" width="20" height="20" />
                            <span>Card</span>
                        }
                        else
                        {
                            <img src="~/assets/svg/project-filled.svg" alt="" width="20" height="20" />
                            <span>Projects</span>
                        }
                    </a>
                    <a href="https://linkedin.com/in/brandonkthomas" class="url-link url-link-external" rel="noopener noreferrer">
                        <span class="url-link-icon-group">
                            <img src="~/assets/svg/external-link-outlined.svg" alt="" width="18" height="18" class="url-link-external-icon" />
                            <img src="~/assets/svg/linkedin-logo-filled.svg" alt="" width="20" height="20" />
                        </span>
                        <span>LinkedIn</span>
                    </a>
                    <a href="mailto:me@brandonthomas.net" class="url-link url-link-external">
                        <span class="url-link-icon-group">
                            <img src="~/assets/svg/external-link-outlined.svg" alt="" width="18" height="18" class="url-link-external-icon" />
                            <img src="~/assets/svg/email-filled.svg" alt="" width="20" height="20" />
                        </span>
                        <span>Contact</span>
                    </a>
                </nav>
            </div>
        </div>
    </div>
    }
    <main role="main">
        @RenderBody()
    </main>
    <environment include="Development">
        @if (!isIsolatedCss)
        {
            <script src="~/js/common.js" type="module"></script>
            <script src="~/js/navbar.js" type="module"></script>
            @if (!canPinchToZoom) // Only load these for the main site page -- can-pinch-to-zoom pages are standalone, not SPA-managed
            {
                <script src="~/js/stateManager.js" type="module"></script>
                <script src="~/js/starfield.js" type="module"></script>
                <script src="~/js/photoGallery.js" type="module"></script>
                <script src="~/js/projects.js" type="module"></script>
            }
        }
    </environment>
    <environment exclude="Development">
        @if (!isIsolatedCss)
        {
            @inject Portfolio.Services.IAssetManifest AssetManifest
            <script src="@AssetManifest.GetAssetPath("common.js")" type="module"></script>
            <script src="@AssetManifest.GetAssetPath("navbar.js")" type="module"></script>
            @if (!canPinchToZoom) // Only load these for the main site page -- can-pinch-to-zoom pages are standalone, not SPA-managed
            {
                <script src="@AssetManifest.GetAssetPath("stateManager.js")" type="module"></script>
                <script src="@AssetManifest.GetAssetPath("starfield.js")" type="module"></script>
                <script src="@AssetManifest.GetAssetPath("photoGallery.js")" type="module"></script>
                <script src="@AssetManifest.GetAssetPath("projects.js")" type="module"></script>
            }
        }
    </environment>
    <script>
        // Expose whether Kestrel debugger is attached (debug-only flag consumed by common.ts)
        window.__dotnetDebuggerAttached = @((System.Diagnostics.Debugger.IsAttached).ToString().ToLower());
    </script>
    @await RenderSectionAsync("Scripts", required: false)
    @if (canPinchToZoom) // For can-pinch-to-zoom pages without the SPA state manager, hide the loading overlay after all assets load.
    {
        <script>
            window.addEventListener('load', () => {
                document.body.dataset.initialState = 'ready';
            });
        </script>
    }
</body>
</html>
